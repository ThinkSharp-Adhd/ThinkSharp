<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ThinkSharp: ADHD Focus Quiz</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(2vh); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-2vw); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes partyPopper {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      50% { transform: translateY(-2vh) rotate(15deg); opacity: 0.8; }
      100% { transform: translateY(-4vh) rotate(30deg); opacity: 0; }
    }
    .fade-in { animation: fadeIn 0.5s ease-out; }
    .slide-in { animation: slideIn 0.5s ease-out; }
    .circle {
      transition: background-color 0.2s ease;
      touch-action: manipulation;
      min-width: 44px;
      min-height: 44px;
      width: 12vw;
      height: 12vw;
      max-width: 60px;
      max-height: 60px;
    }
    .circle:active {
      transform: scale(1.1);
      opacity: 0.9;
      cursor: pointer;
    }
    .task-item {
      transition: background-color 0.3s ease;
      touch-action: manipulation;
    }
    .task-item:active {
      transform: translateX(0.5vw);
      background-color: #e5e7eb;
    }
    .dark .task-item:active {
      background-color: #6b7280;
    }
    .loader-dot {
      animation: pulse 1.5s ease-in-out infinite;
      animation-delay: calc(0.2s * var(--i));
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 0.5; }
      50% { transform: scale(1.5); opacity: 1; }
    }
    .loader-hidden {
      display: none !important;
      animation: none !important;
    }
    .disabled {
      opacity: 0.5;
      pointer-events: none;
    }
    .party-popper {
      position: absolute;
      font-size: 1.5rem;
      animation: partyPopper 1s ease-out forwards;
    }
    .progress-bar {
      height: 1vh;
      background-color: #4caf50;
      transition: width 0.3s ease;
    }
    .dark .progress-bar {
      background-color: #34d399;
    }
    .modal {
      backdrop-filter: blur(5px);
    }
    button, input[type="checkbox"], input[type="text"], textarea {
      min-width: 44px;
      min-height: 44px;
      touch-action: manipulation;
    }
    button {
      padding: 0.5rem 1rem;
    }
    input[type="checkbox"] {
      width: 1.5rem;
      height: 1.5rem;
    }
    textarea, input[type="text"] {
      padding: 0.5rem;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-[100vh] flex items-center justify-center transition-colors duration-300" id="body">
  <div id="app" class="w-[90vw] max-w-[600px] min-w-[300px] mx-auto p-[4vw] sm:p-[2vw] bg-white rounded-xl shadow-lg relative transition-colors duration-300">
    <div id="login" class="flex flex-col items-center justify-center h-[40vh] sm:h-[30vh]">
      <h2 class="text-[1.5rem] font-semibold mb-[2vh] text-gray-800 dark:text-gray-200">Login</h2>
      <button id="google-sign-in" class="py-[1vh] px-[2vw] bg-blue-500 text-white rounded hover:bg-blue-600">Login with Google</button>
      <div id="user-info" class="mt-[2vh] text-[1rem] text-gray-700 dark:text-gray-300"></div>
    </div>
    <div id="loader" class="flex justify-center items-center h-[40vh] sm:h-[30vh] hidden">
      <div class="flex space-x-[1vw]">
        <div class="w-[2vw] h-[2vw] min-w-[8px] min-h-[8px] bg-blue-500 rounded-full loader-dot" style="--i: 0;"></div>
        <div class="w-[2vw] h-[2vw] min-w-[8px] min-h-[8px] bg-blue-500 rounded-full loader-dot" style="--i: 1;"></div>
        <div class="w-[2vw] h-[2vw] min-w-[8px] min-h-[8px] bg-blue-500 rounded-full loader-dot" style="--i: 2;"></div>
      </div>
    </div>
    <div id="quiz" class="quiz-container hidden">
      <div class="question text-[1.2rem] sm:text-[1.5rem] font-semibold text-gray-800 mb-[2vh] text-center dark:text-gray-200" id="question">
        <p>Loading...</p>
      </div>
      <div class="options flex flex-wrap justify-between gap-[1vw] mb-[2vh]" id="options"></div>
      <div class="labels flex justify-between text-[0.8rem] sm:text-[0.9rem] text-gray-600 dark:text-gray-400">
        <span>Never</span>
        <span>Rarely</span>
        <span>Sometimes</span>
        <span>Often</span>
        <span>Always</span>
      </div>
    </div>
    <div id="result-screen" class="hidden">
      <div class="xp-level text-[1rem] sm:text-[1.2rem] font-semibold text-center mb-[1vh] text-gray-800 dark:text-gray-200" id="xpLevel"></div>
      <div class="progress-bar-container w-full bg-gray-200 rounded-full mb-[2vh] dark:bg-gray-700">
        <div class="progress-bar rounded-full" id="xpProgress"></div>
      </div>
      <div class="quiz-result text-[1.5rem] sm:text-[2rem] font-bold text-center mb-[2vh] text-gray-800 dark:text-gray-200" id="score"></div>
      <div class="task-list space-y-[1vh]" id="tasks"></div>
      <div class="flex space-x-[1vw] mt-[2vh]">
        <button class="retake-btn w-full py-[1vh] bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-[1rem] sm:text-[1.1rem]" id="settings-btn">Settings</button>
      </div>
    </div>
    <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center modal">
      <div class="bg-white p-[4vw] rounded-xl w-[80vw] max-w-[400px] dark:bg-gray-800">
        <h2 class="text-[1.2rem] font-semibold mb-[2vh] text-gray-800 dark:text-gray-200">Settings</h2>
        <div class="flex items-center justify-between mb-[2vh]">
          <label class="text-[1rem] text-gray-700 dark:text-gray-300">Dark Mode</label>
          <input type="checkbox" id="darkModeToggle" class="w-[4vw] h-[4vw] min-w-[16px] min-h-[16px]">
        </div>
        <button class="w-full py-[1vh] bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-[1rem]" id="retake-btn">Retake Quiz</button>
        <button class="w-full py-[1vh] mt-[1vh] bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-[1rem]" id="logout-btn">Logout</button>
        <button class="w-full py-[1vh] mt-[1vh] bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-[1rem]" id="close-settings-btn">Close</button>
      </div>
    </div>

    <script type="module">
      // Import Firebase SDK modules
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
      import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
      import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
      import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js';

      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBlgQqPVQjAr_edKWGiVmS5hIGGCXRU9Vc",
        authDomain: "website-login-8697b.firebaseapp.com",
        projectId: "website-login-8697b",
        storageBucket: "website-login-8697b.firebasestorage.app",
        messagingSenderId: "154630434494",
        appId: "1:154630434494:web:1318fa05715939809938ef",
        measurementId: "G-Y1SW4V8THL"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const analytics = getAnalytics(app);
      const provider = new GoogleAuthProvider();
      console.log("Firebase initialized:", app);

      // Initialize audio objects
      const sounds = {
        reward: new Audio('sounds/reward_sound.mp3'),
        end: new Audio('sounds/end_sound.mp3'),
        start: new Audio('sounds/start_sound.mp3'),
        meditation: new Audio('sounds/meditation_music.mp3')
      };
      sounds.meditation.loop = true; // Loop meditation music

      // Helper to play sound with error handling
      function playSound(soundKey) {
        const sound = sounds[soundKey];
        if (sound) {
          try {
            sound.currentTime = 0; // Reset to start
            sound.play().catch(error => {
              console.error(`Error playing ${soundKey} sound:`, error);
            });
          } catch (error) {
            console.error(`Error triggering ${soundKey} sound:`, error);
          }
        } else {
          console.warn(`Sound ${soundKey} not found`);
        }
      }

      // Helper to stop sound
      function stopSound(soundKey) {
        const sound = sounds[soundKey];
        if (sound) {
          try {
            sound.pause();
            sound.currentTime = 0;
          } catch (error) {
            console.error(`Error stopping ${soundKey} sound:`, error);
          }
        }
      }

      // Questions and tasks
      const questions = [
        { q: "You find it hard to sit still for long periods.", scores: [0, 1, 2, 3, 4] },
        { q: "You get distracted easily during tasks.", scores: [0, 1, 2, 3, 4] },
        { q: "You have trouble organizing tasks or activities.", scores: [0, 1, 2, 3, 4] },
        { q: "You frequently forget things like appointments or obligations.", scores: [0, 1, 2, 3, 4] },
        { q: "You feel like your thoughts are racing and hard to control.", scores: [0, 1, 2, 3, 4] }
      ];
      const tasksBySeverity = {
        mild: [
          { text: "Try a 5-minute mindfulness breathing exercise after each task.", action: 'meditation' },
          { text: "Use a Pomodoro timer: 25 minutes focus, 5 minutes break.", action: 'pomodoro' },
          { text: "Keep a notepad for quick jotting of to-dos.", action: 'notepad' }
        ],
        moderate: [
          { text: "Designate a distraction-free workspace with minimal stimuli.", action: 'workspace' },
          { text: "Create a daily checklist each morning and tick off items.", action: 'checklist' },
          { text: "Use a focus-blocking app for 45-minute sessions.", action: 'focusBlock' }
        ],
        severe: [
          { text: "Break tasks into 5-minute micro-tasks and reward yourself after each.", action: 'microTask' },
          { text: "Schedule structured cycles: 15 minutes work / 5 minutes move/stretch.", action: 'workStretch' },
          { text: "Pair with an accountability buddy and check in hourly.", action: 'accountability' }
        ]
      };

      let current = 0, total = 0;
      const maxScore = questions.length * 4;
      let timerInterval = null;
      let pomodoroPhase = 'focus';
      let pomodoroCycles = 0;
      let currentActiveTask = null;
      let notepadStates = {};
      let xp = 0;
      let level = 1;
      const xpPerTask = 10;
      const xpPerLevel = 100;
      let completedTasks = [];
      let quizState = null;
      let userId = null;
      let darkMode = false;

      // Detect if device is mobile
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      // Helper to add click and touch events
      function addInteractionListener(element, handler) {
        element.addEventListener('click', handler);
        if (isMobile) {
          element.addEventListener('touchstart', (e) => {
            e.preventDefault();
            handler(e);
          });
        }
      }

      function updateXP(addXP = 0) {
        xp += addXP;
        level = Math.floor(xp / xpPerLevel) + 1;
        saveUserData();
        const xpLevelEl = document.getElementById('xpLevel');
        const xpProgressEl = document.getElementById('xpProgress');
        if (xpLevelEl && xpProgressEl) {
          xpLevelEl.textContent = `Level ${level} - XP: ${xp % xpPerLevel}/${xpPerLevel}`;
          xpProgressEl.style.width = `${(xp % xpPerLevel) / xpPerLevel * 100}%`;
        }
        console.log("XP updated:", xp, "Level:", level);
      }

      function triggerPartyPopper(targetElement) {
        const popperContainer = document.createElement('div');
        popperContainer.style.position = 'absolute';
        popperContainer.style.left = `${targetElement.getBoundingClientRect().left}px`;
        popperContainer.style.top = `${targetElement.getBoundingClientRect().top - 20}px`;
        const emojis = ['ðŸŽ‰', 'ðŸ¥³', 'ðŸŽˆ'];
        const popperCount = isMobile ? 5 : 10;
        for (let i = 0; i < popperCount; i++) {
          const popper = document.createElement('span');
          popper.className = 'party-popper';
          popper.textContent = emojis[Math.floor(Math.random() * emojis.length)];
          popper.style.left = `${Math.random() * 50 - 25}px`;
          popper.style.animationDelay = `${Math.random() * 0.5}s`;
          popper.style.transform = `rotate(${Math.random() * 60 - 30}deg)`;
          popperContainer.appendChild(popper);
        }
        document.getElementById('app').appendChild(popperContainer);
        setTimeout(() => popperContainer.remove(), 2000);
      }

      function toggleDarkMode() {
        darkMode = document.getElementById('darkModeToggle').checked;
        document.getElementById('body').classList.toggle('dark', darkMode);
        document.getElementById('app').classList.toggle('bg-gray-900', darkMode);
        document.getElementById('app').classList.toggle('bg-white', !darkMode);
        document.getElementById('app').classList.toggle('text-gray-200', darkMode);
        document.getElementById('app').classList.toggle('text-gray-800', !darkMode);
        saveUserData();
      }

      function openSettings() {
        document.getElementById('settings-modal').classList.remove('hidden');
      }

      function closeSettings() {
        document.getElementById('settings-modal').classList.add('hidden');
      }

      function retakeQuiz() {
        current = total = 0;
        quizState = null;
        completedTasks = [];
        notepadStates = {};
        saveUserData();
        document.getElementById('settings-modal').classList.add('hidden');
        document.getElementById('result-screen').classList.add('hidden');
        document.getElementById('quiz').classList.remove('hidden');
        document.getElementById('quiz').classList.add('fade-in');
        loadQuestion();
      }

      function signOutUser() {
        signOut(auth).then(() => {
          document.getElementById('settings-modal').classList.add('hidden');
          location.reload();
        }).catch((error) => {
          console.error("Sign-out error:", error);
        });
      }

      function loginWithGoogle() {
        console.log("Starting Google Sign-In");
        signInWithPopup(auth, provider)
          .then((result) => {
            userId = result.user.uid;
            console.log("Signed in, userId:", userId);
            document.getElementById('user-info').textContent = `Signed in as ${result.user.displayName}`;
            loadUserData();
          })
          .catch((error) => {
            console.error("Google Sign-In error:", error);
            document.getElementById('user-info').textContent = "Login failed. Try again.";
          });
      }

      async function loadUserData() {
        if (!userId) {
          console.error("No userId, starting quiz");
          startQuiz();
          return;
        }
        try {
          console.log("Fetching user data for:", userId);
          const userDocRef = doc(db, 'users', userId);
          const userDoc = await getDoc(userDocRef);
          console.log("User doc exists:", userDoc.exists());
          const userData = userDoc.exists() ? userDoc.data() : {};
          quizState = userData.quizState || null;
          completedTasks = userData.completedTasks || [];
          notepadStates = userData.notepadStates || {};
          xp = userData.xp || 0;
          darkMode = userData.darkMode || false;
          level = Math.floor(xp / xpPerLevel) + 1;
          document.getElementById('darkModeToggle').checked = darkMode;
          document.getElementById('body').classList.toggle('dark', darkMode);
          document.getElementById('app').classList.toggle('bg-gray-900', darkMode);
          document.getElementById('app').classList.toggle('bg-white', !darkMode);
          document.getElementById('app').classList.toggle('text-gray-200', darkMode);
          document.getElementById('app').classList.toggle('text-gray-800', !darkMode);
          document.getElementById('login').classList.add('hidden');
          console.log("Quiz state:", quizState);
          if (quizState) {
            showResult();
          } else {
            startQuiz();
          }
        } catch (error) {
          console.error("Error loading user data:", error);
          document.getElementById('login').classList.add('hidden');
          startQuiz();
        }
      }

      async function saveUserData() {
        if (!userId) {
          console.error("No userId, cannot save data");
          return;
        }
        try {
          console.log("Saving user data for:", userId);
          await setDoc(doc(db, 'users', userId), {
            quizState,
            completedTasks,
            notepadStates,
            xp,
            darkMode
          }, { merge: true });
          console.log("User data saved successfully");
        } catch (error) {
          console.error("Error saving user data:", error);
        }
      }

      window.onload = () => {
        console.log("Window loaded, setting up app");
        // Preload sounds
        Object.values(sounds).forEach(sound => {
          sound.load();
        });

        addInteractionListener(document.getElementById('google-sign-in'), loginWithGoogle);
        document.getElementById('darkModeToggle').addEventListener('change', toggleDarkMode);
        addInteractionListener(document.getElementById('settings-btn'), openSettings);
        addInteractionListener(document.getElementById('retake-btn'), retakeQuiz);
        addInteractionListener(document.getElementById('logout-btn'), signOutUser);
        addInteractionListener(document.getElementById('close-settings-btn'), closeSettings);

        onAuthStateChanged(auth, user => {
          console.log("Auth state changed, user:", user ? user.uid : "none");
          if (user) {
            userId = user.uid;
            document.getElementById('user-info').textContent = `Signed in as ${user.displayName}`;
            loadUserData();
          } else {
            document.getElementById('loader').classList.add('loader-hidden');
            document.getElementById('login').classList.remove('hidden');
            document.getElementById('user-info').textContent = "Please sign in.";
          }
        });
      };

      function startQuiz() {
        console.log("Starting quiz");
        document.getElementById('loader').classList.add('loader-hidden');
        setTimeout(() => {
          document.getElementById('quiz').classList.remove('hidden');
          document.getElementById('quiz').classList.add('fade-in');
          loadQuestion();
        }, 1500);
      }

      function loadQuestion() {
        const q = questions[current];
        if (!q) {
          console.error('Question not found for index:', current);
          return;
        }
        console.log("Loading question:", current + 1);
        document.getElementById('loader').classList.add('loader-hidden');
        const questionEl = document.getElementById('question');
        questionEl.innerHTML = `<p class="slide-in">${q.q}</p>`;
        const opts = document.getElementById('options');
        opts.innerHTML = '';
        ['Never', 'Rarely', 'Sometimes', 'Often', 'Always'].forEach((label, i) => {
          const c = document.createElement('div');
          c.className = `circle rounded-full ${['bg-red-400', 'bg-orange-400', 'bg-yellow-400', 'bg-green-400', 'bg-blue-400'][i]} flex items-center justify-center text-white font-semibold`;
          c.setAttribute('title', label);
          c.textContent = label.charAt(0);
          c.dataset.index = i;
          opts.appendChild(c);
        });
        addInteractionListener(opts, (e) => {
          const circle = e.target.closest('.circle');
          if (circle && !circle.classList.contains('disabled')) {
            const idx = parseInt(circle.dataset.index);
            select(idx);
          }
        });
        setTimeout(() => {
          opts.querySelectorAll('.circle').forEach((el, i) => {
            el.style.animationDelay = `${i * 0.1}s`;
            el.classList.add('slide-in');
          });
        }, 10);
      }

      function select(idx) {
        total += questions[current].scores[idx];
        console.log("Selected option:", idx, "Score:", questions[current].scores[idx], "Total:", total);
        current++;
        if (current < questions.length) {
          loadQuestion();
        } else {
          showResult();
        }
      }

      function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
      }

      function startTimer(duration, display, onEnd, onTick = () => {}) {
        let timeLeft = duration;
        display.textContent = formatTime(timeLeft);
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          timeLeft--;
          display.textContent = formatTime(timeLeft);
          onTick();
          if (timeLeft <= 0) {
            clearInterval(timerInterval);
            onEnd();
          }
        }, 1000);
      }

      function disableTaskButtons(exceptIndex = null) {
        document.querySelectorAll('.task-item button:not(.retake-btn)').forEach(btn => {
          if (exceptIndex !== null && btn.parentElement.id.includes(`${exceptIndex}`)) return;
          btn.classList.add('disabled');
        });
      }

      function enableTaskButtons() {
        document.querySelectorAll('.task-item button').forEach(btn => {
          if (!btn.classList.contains('completed')) {
            btn.classList.remove('disabled');
          }
        });
      }

      function markTaskCompleted(taskId, button) {
        if (!completedTasks.includes(taskId)) {
          completedTasks.push(taskId);
          saveUserData();
          if (button) {
            button.classList.add('disabled', 'completed');
            button.textContent = 'Completed';
          }
          playSound('reward');
          checkAllTasksCompleted();
        }
        console.log("Task completed:", taskId);
      }

      function checkAllTasksCompleted() {
        const allCompleted = quizState.tasks.every((task, i) => completedTasks.includes(`${task.action}${i}`));
        if (allCompleted) {
          const tasksEl = document.getElementById('tasks');
          const refreshButton = document.createElement('button');
          refreshButton.className = 'w-full py-[1vh] mt-[2vh] bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors text-[1rem]';
          refreshButton.textContent = 'Get New Tasks';
          addInteractionListener(refreshButton, resetTasks);
          tasksEl.appendChild(refreshButton);
        }
      }

      function resetTasks() {
        completedTasks = [];
        saveUserData();
        showResult();
        console.log("Tasks reset");
      }

      function showResult() {
        console.log("Showing result, total score:", total);
        document.getElementById('quiz').classList.add('hidden');
        document.getElementById('loader').classList.add('loader-hidden');
        let percent, severity;
        if (quizState) {
          percent = quizState.percent;
          severity = quizState.severity;
        } else {
          percent = Math.round((total / maxScore) * 100);
          severity = percent < 40 ? 'mild' : percent <= 70 ? 'moderate' : 'severe';
          quizState = { percent, severity, tasks: tasksBySeverity[severity] };
          saveUserData();
        }
        const scoreEl = document.getElementById('score');
        scoreEl.textContent = `Focus Score: ${percent}%`;
        scoreEl.className = `quiz-result text-[1.5rem] sm:text-[2rem] font-bold text-center mb-[2vh] fade-in ${percent < 40 ? 'text-green-500' : percent <= 70 ? 'text-yellow-500' : 'text-red-500'}`;
        updateXP(0);

        const tasksEl = document.getElementById('tasks');
        tasksEl.innerHTML = '';
        quizState.tasks.forEach((task, i) => {
          const div = document.createElement('div');
          div.className = 'task-item flex items-center space-x-[1vw] slide-in';
          div.id = `task-${i}`;
          div.style.animationDelay = `${i * 0.2}s`;
          let actionHtml = '';
          const taskId = `${task.action}${i}`;
          const isCompleted = completedTasks.includes(taskId);
          if (task.action === 'meditation') {
            actionHtml = `
              <button id="meditation-start-${i}" class="ml-[1vw] py-[0.5rem] px-[1rem] bg-blue-500 text-white rounded hover:bg-blue-600 ${isCompleted ? 'disabled completed' : ''}">${isCompleted ? 'Completed' : 'Start'}</button>
              <div id="meditationTimer${i}" class="hidden ml-[1vw]">
                <span id="meditationDisplay${i}" class="text-[0.9rem]"></span>
                <button id="meditation-stop-${i}" class="ml-[1vw] py-[0.5rem] px-[1rem] bg-red-500 text-white rounded hover:bg-red-600">Stop</button>
              </div>`;
          } else if (task.action === 'pomodoro') {
            actionHtml = `
              <button id="pomodoro-start-${i}" class="ml-[1vw] py-[0.5rem] px-[1rem] bg-blue-500 text-white rounded hover:bg-blue-600 ${isCompleted ? 'disabled completed' : ''}">${isCompleted ? 'Completed' : 'Start'}</button>
              <div id="pomodoroTimer${i}" class="hidden ml-[1vw]">
                <span id="pomodoroDisplay${i}" class="text-[0.9rem]"></span>
                <button id="pomodoro-stop-${i}" class="ml-[1vw] py-[0.5rem] px-[1rem] bg-red-500 text-white rounded hover:bg-red-600">Stop</button>
              </div>`;
          } else if (task.action === 'notepad') {
            actionHtml = `
              <div class="ml-[1vw] w-full">
                <textarea id="notepad${i}" class="w-full max-w-[300px] h-[80px] resize-none p-[0.5rem] border rounded text-[0.9rem] dark:bg-gray-700 dark:text-gray-200" placeholder="Jot down your to-dos..."></textarea>
                <div class="flex space-x-[1vw] mt-[0.5vh]">
                  <button id="notepad-save-${i}" class="py-[0.5rem] px-[1rem] bg-blue-500 text-white rounded hover:bg-blue-600 ${isCompleted ? 'disabled completed' : ''}">${isCompleted ? 'Completed' : 'Save'}</button>
                  <button id="notepad-clear-${i}" class="py-[0.5rem] px-[1rem] bg-gray-500 text-white rounded hover:bg-gray-600">Clear</button>
                </div>
                <div id="notepadList${i}" class="mt-[1vh] text-[0.9rem]"></div>
              </div>`;
          } else if (task.action === 'workspace') {
            actionHtml = `
              <p class="ml-[1vw] text-[0.9rem] italic dark:text-gray-300">Clear your desk and silence notifications!</p>
              <button id="workspace-complete-${i}" class="ml-[1vw] py-[0.5rem] px-[1rem] bg-blue-500 text-white rounded hover:bg-blue-600 ${isCompleted ? 'disabled completed' : ''}">${isCompleted ? 'Completed' : 'Mark as Completed'}</button>`;
          } else if (task.action === 'checklist') {
            actionHtml = `
              <div class="ml-[1vw]">
                <input id="checklistInput${i}" class="p-[0.5rem] border rounded text-[0.9rem] dark:bg-gray-700 dark:text-gray-200" placeholder="Add task...">
                <button id="checklist-add-${i}" class="ml-[0.5vw] py-[0.5rem] px-[1rem] bg-blue-500 text-white rounded hover:bg-blue-600 ${isCompleted ? 'disabled completed' : ''}">${isCompleted ? 'Completed' : 'Add'}</button>
                <div id="checklist${i}" class="mt-[1vh]"></div>
              </div>`;
          } else if (task.action === 'focusBlock') {
            actionHtml = `
              <button id="focusBlock-start-${i}" class="ml-[1vw] py-[0.5rem] px-[1rem] bg-blue-500 text-white rounded hover:bg-blue-600 ${isCompleted ? 'disabled completed' : ''}">${isCompleted ? 'Completed' : 'Start'}</button>
              <div id="focusBlockTimer${i}" class="hidden ml-[1vw]">
                <span id="focusBlockDisplay${i}" class="text-[0.9rem]"></span>
                <button id="focusBlock-stop-${i}" class="ml-[1vw] py-[0.5rem] px-[1rem] bg-red-500 text-white rounded hover:bg-red-600">Stop</button>
              </div>`;
          } else if (task.action === 'microTask') {
            actionHtml = `
              <button id="microTask-start-${i}" class="ml-[1vw] py-[0.5rem] px-[1rem] bg-blue-500 text-white rounded hover:bg-blue-600 ${isCompleted ? 'disabled completed' : ''}">${isCompleted ? 'Completed' : 'Start'}</button>
              <div id="microTaskTimer${i}" class="hidden ml-[1vw]">
                <span id="microTaskDisplay${i}" class="text-[0.9rem]"></span>
                <button id="microTask-complete-${i}" class="ml-[1vw] py-[0.5rem] px-[1rem] bg-green-500 text-white rounded hover:bg-green-600">Done</button>
                <button id="microTask-stop-${i}" class="ml-[1vw] py-[0.5rem] px-[1rem] bg-red-500 text-white rounded hover:bg-red-600">Stop</button>
              </div>`;
          } else if (task.action === 'workStretch') {
            actionHtml = `
              <button id="workStretch-start-${i}" class="ml-[1vw] py-[0.5rem] px-[1rem] bg-blue-500 text-white rounded hover:bg-blue-600 ${isCompleted ? 'disabled completed' : ''}">${isCompleted ? 'Completed' : 'Start'}</button>
              <div id="workStretchTimer${i}" class="hidden ml-[1vw]">
                <span id="workStretchDisplay${i}" class="text-[0.9rem]"></span>
                <button id="workStretch-stop-${i}" class="ml-[1vw] py-[0.5rem] px-[1rem] bg-red-500 text-white rounded hover:bg-red-600">Stop</button>
              </div>`;
          } else if (task.action === 'accountability') {
            actionHtml = `
              <input id="accountability${i}" class="ml-[1vw] p-[0.5rem] border rounded text-[0.9rem] dark:bg-gray-700 dark:text-gray-200" placeholder="Enter buddy's contact info...">
              <button id="accountability-complete-${i}" class="ml-[1vw] py-[0.5rem] px-[1rem] bg-blue-500 text-white rounded hover:bg-blue-600 ${isCompleted ? 'disabled completed' : ''}">${isCompleted ? 'Completed' : 'Mark as Completed'}</button>`;
          }
          div.innerHTML = `
            <svg class="task-icon w-[5vw] h-[5vw] min-w-[20px] min-h-[20px] max-w-[30px] max-h-[30px] text-${severity === 'mild' ? 'green' : severity === 'moderate' ? 'yellow' : 'red'}-500" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="10" fill="currentColor"/>
              <path d="M10 15l-3-3 1.5-1.5L10 12l5-5 1.5 1.5z" fill="white"/>
            </svg>
            <p class="text-gray-700 text-[0.9rem] sm:text-[1rem] dark:text-gray-300">${task.text}</p>
            ${actionHtml}`;
          tasksEl.appendChild(div);
          if (task.action === 'notepad' && notepadStates[taskId]) {
            const notepadList = document.getElementById(`notepadList${i}`);
            notepadStates[taskId].forEach(value => {
              const div = document.createElement('div');
              div.className = 'flex items-center space-x-[1vw] mt-[0.5vh]';
              div.innerHTML = `<span class="text-[0.9rem]">${value}</span>`;
              notepadList.appendChild(div);
            });
          }

          if (task.action === 'meditation') {
            const startBtn = document.getElementById(`meditation-start-${i}`);
            const stopBtn = document.getElementById(`meditation-stop-${i}`);
            if (startBtn && !isCompleted) addInteractionListener(startBtn, () => startMeditation(i));
            if (stopBtn) addInteractionListener(stopBtn, () => stopMeditation(i));
          } else if (task.action === 'pomodoro') {
            const startBtn = document.getElementById(`pomodoro-start-${i}`);
            const stopBtn = document.getElementById(`pomodoro-stop-${i}`);
            if (startBtn && !isCompleted) addInteractionListener(startBtn, () => startPomodoro(i));
            if (stopBtn) addInteractionListener(stopBtn, () => stopPomodoro(i));
          } else if (task.action === 'notepad') {
            const saveBtn = document.getElementById(`notepad-save-${i}`);
            const clearBtn = document.getElementById(`notepad-clear-${i}`);
            if (saveBtn && !isCompleted) addInteractionListener(saveBtn, () => saveNotepad(i));
            if (clearBtn) addInteractionListener(clearBtn, () => clearNotepad(i));
          } else if (task.action === 'workspace') {
            const completeBtn = document.getElementById(`workspace-complete-${i}`);
            if (completeBtn && !isCompleted) addInteractionListener(completeBtn, () => completeWorkspace(i));
          } else if (task.action === 'checklist') {
            const addBtn = document.getElementById(`checklist-add-${i}`);
            if (addBtn && !isCompleted) addInteractionListener(addBtn, () => addChecklistItem(i));
          } else if (task.action === 'focusBlock') {
            const startBtn = document.getElementById(`focusBlock-start-${i}`);
            const stopBtn = document.getElementById(`focusBlock-stop-${i}`);
            if (startBtn && !isCompleted) addInteractionListener(startBtn, () => startFocusBlock(i));
            if (stopBtn) addInteractionListener(stopBtn, () => stopFocusBlock(i));
          } else if (task.action === 'microTask') {
            const startBtn = document.getElementById(`microTask-start-${i}`);
            const completeBtn = document.getElementById(`microTask-complete-${i}`);
            const stopBtn = document.getElementById(`microTask-stop-${i}`);
            if (startBtn && !isCompleted) addInteractionListener(startBtn, () => startMicroTask(i));
            if (completeBtn) addInteractionListener(completeBtn, () => completeMicroTask(i));
            if (stopBtn) addInteractionListener(stopBtn, () => stopMicroTask(i));
          } else if (task.action === 'workStretch') {
            const startBtn = document.getElementById(`workStretch-start-${i}`);
            const stopBtn = document.getElementById(`workStretch-stop-${i}`);
            if (startBtn && !isCompleted) addInteractionListener(startBtn, () => startWorkStretch(i));
            if (stopBtn) addInteractionListener(stopBtn, () => stopWorkStretch(i));
          } else if (task.action === 'accountability') {
            const completeBtn = document.getElementById(`accountability-complete-${i}`);
            if (completeBtn && !isCompleted) addInteractionListener(completeBtn, () => completeAccountability(i));
          }
        });
        document.getElementById('result-screen').classList.remove('hidden');
        document.getElementById('result-screen').classList.add('fade-in');
        checkAllTasksCompleted();
        console.log("Result screen displayed, tasks:", quizState.tasks);
      }

      function stopAllTimers() {
        clearInterval(timerInterval);
        document.querySelectorAll('[id^="meditationTimer"],[id^="pomodoroTimer"],[id^="focusBlockTimer"],[id^="microTaskTimer"],[id^="workStretchTimer"]').forEach(el => el.classList.add('hidden'));
        stopSound('meditation');
        currentActiveTask = null;
        enableTaskButtons();
      }

      function startMeditation(index) {
        const taskId = `meditation${index}`;
        if (currentActiveTask !== null || completedTasks.includes(taskId)) return;
        currentActiveTask = taskId;
        disableTaskButtons(index);
        const timerDiv = document.getElementById(`meditationTimer${index}`);
        const display = document.getElementById(`meditationDisplay${index}`);
        const button = document.getElementById(`meditation-start-${index}`);
        timerDiv.classList.remove('hidden');
        playSound('start');
        playSound('meditation');
        startTimer(300, display, () => {
          triggerPartyPopper(timerDiv);
          updateXP(xpPerTask);
          markTaskCompleted(taskId, button);
          stopSound('meditation');
          timerDiv.classList.add('hidden');
          currentActiveTask = null;
          enableTaskButtons();
        });
        console.log("Meditation started, task:", taskId);
      }

      function stopMeditation(index) {
        clearInterval(timerInterval);
        document.getElementById(`meditationTimer${index}`).classList.add('hidden');
        stopSound('meditation');
        playSound('end');
        currentActiveTask = null;
        enableTaskButtons();
        console.log("Meditation stopped, index:", index);
      }

      function startPomodoro(index) {
        const taskId = `pomodoro${index}`;
        if (currentActiveTask !== null || completedTasks.includes(taskId)) return;
        currentActiveTask = taskId;
        disableTaskButtons(index);
        const timerDiv = document.getElementById(`pomodoroTimer${index}`);
        const display = document.getElementById(`pomodoroDisplay${index}`);
        const button = document.getElementById(`pomodoro-start-${index}`);
        timerDiv.classList.remove('hidden');
        playSound('start');
        pomodoroPhase = 'focus';
        pomodoroCycles = 0;
        runPomodoro(index, display, timerDiv, button);
        console.log("Pomodoro started, task:", taskId);
      }

      function runPomodoro(index, display, timerDiv, button) {
        const duration = pomodoroPhase === 'focus' ? 1500 : 300;
        startTimer(duration, display, () => {
          if (pomodoroPhase === 'focus') {
            pomodoroPhase = 'break';
            runPomodoro(index, display, timerDiv, button);
          } else {
            pomodoroCycles++;
            if (pomodoroCycles < 4) {
              pomodoroPhase = 'focus';
              runPomodoro(index, display, timerDiv, button);
            } else {
              triggerPartyPopper(timerDiv);
              updateXP(xpPerTask);
              markTaskCompleted(`pomodoro${index}`, button);
              timerDiv.classList.add('hidden');
              currentActiveTask = null;
              enableTaskButtons();
            }
          }
        }, () => {
          display.textContent = `${pomodoroPhase === 'focus' ? 'Focus' : 'Break'}: ${display.textContent}`;
        });
      }

      function stopPomodoro(index) {
        clearInterval(timerInterval);
        document.getElementById(`pomodoroTimer${index}`).classList.add('hidden');
        playSound('end');
        currentActiveTask = null;
        enableTaskButtons();
        console.log("Pomodoro stopped, index:", index);
      }

      function saveNotepad(index) {
        const taskId = `notepad${index}`;
        if (currentActiveTask !== null && currentActiveTask !== taskId || completedTasks.includes(taskId)) return;
        currentActiveTask = taskId;
        disableTaskButtons(index);
        const textarea = document.getElementById(`notepad${index}`);
        const notepadList = document.getElementById(`notepadList${index}`);
        const button = document.getElementById(`notepad-save-${index}`);
        const value = textarea.value.trim();
        if (value && (!notepadStates[taskId] || !notepadStates[taskId].includes(value))) {
          notepadStates[taskId] = notepadStates[taskId] || [];
          notepadStates[taskId].push(value);
          saveUserData();
          const div = document.createElement('div');
          div.className = 'flex items-center space-x-[1vw] mt-[0.5vh]';
          div.innerHTML = `<span class="text-[0.9rem]">${value}</span>`;
          notepadList.appendChild(div);
          triggerPartyPopper(notepadList);
          updateXP(xpPerTask);
          markTaskCompleted(taskId, button);
          textarea.value = '';
        }
        currentActiveTask = null;
        enableTaskButtons();
        console.log("Notepad saved, task:", taskId);
      }

      function clearNotepad(index) {
        const taskId = `notepad${index}`;
        if (currentActiveTask !== null && currentActiveTask !== taskId) return;
        currentActiveTask = taskId;
        disableTaskButtons(index);
        document.getElementById(`notepad${index}`).value = '';
        document.getElementById(`notepadList${index}`).innerHTML = '';
        notepadStates[taskId] = [];
        saveUserData();
        currentActiveTask = null;
        enableTaskButtons();
        console.log("Notepad cleared, task:", taskId);
      }

      function completeWorkspace(index) {
        const taskId = `workspace${index}`;
        if (completedTasks.includes(taskId)) return;
        const button = document.getElementById(`workspace-complete-${index}`);
        triggerPartyPopper(button);
        updateXP(xpPerTask);
        markTaskCompleted(taskId, button);
        console.log("Workspace completed, task:", taskId);
      }

      function addChecklistItem(index) {
        const taskId = `checklist${index}`;
        if (currentActiveTask !== null && currentActiveTask !== taskId || completedTasks.includes(taskId)) return;
        currentActiveTask = taskId;
        disableTaskButtons(index);
        const input = document.getElementById(`checklistInput${index}`);
        const checklist = document.getElementById(`checklist${index}`);
        const button = document.getElementById(`checklist-add-${index}`);
        if (input.value.trim()) {
          const div = document.createElement('div');
          div.className = 'flex items-center space-x-[1vw] mt-[0.5vh]';
          div.innerHTML = `
            <input type="checkbox" class="w-[1.5rem] h-[1.5rem]">
            <span class="text-[0.9rem]">${input.value}</span>`;
          const checkbox = div.querySelector('input');
          addInteractionListener(checkbox, () => {
            if (checkbox.checked) {
              triggerPartyPopper(checkbox);
              updateXP(xpPerTask);
              markTaskCompleted(`checklist${index}`, button);
              div.classList.add('line-through', 'text-gray-500', 'dark:text-gray-400');
            }
          });
          checklist.appendChild(div);
          input.value = '';
        }
        currentActiveTask = null;
        enableTaskButtons();
        console.log("Checklist item added, task:", taskId);
      }

      function startFocusBlock(index) {
        const taskId = `focusBlock${index}`;
        if (currentActiveTask !== null || completedTasks.includes(taskId)) return;
        currentActiveTask = taskId;
        disableTaskButtons(index);
        const timerDiv = document.getElementById(`focusBlockTimer${index}`);
        const display = document.getElementById(`focusBlockDisplay${index}`);
        const button = document.getElementById(`focusBlock-start-${index}`);
        timerDiv.classList.remove('hidden');
        playSound('start');
        startTimer(2700, display, () => {
          triggerPartyPopper(timerDiv);
          updateXP(xpPerTask);
          markTaskCompleted(taskId, button);
          timerDiv.classList.add('hidden');
          currentActiveTask = null;
          enableTaskButtons();
        });
        console.log("Focus block started, task:", taskId);
      }

      function stopFocusBlock(index) {
        clearInterval(timerInterval);
        document.getElementById(`focusBlockTimer${index}`).classList.add('hidden');
        playSound('end');
        currentActiveTask = null;
        enableTaskButtons();
        console.log("Focus block stopped, index:", index);
      }

      function startMicroTask(index) {
        const taskId = `microTask${index}`;
        if (currentActiveTask !== null || completedTasks.includes(taskId)) return;
        currentActiveTask = taskId;
        disableTaskButtons(index);
        const timerDiv = document.getElementById(`microTaskTimer${index}`);
        const display = document.getElementById(`microTaskDisplay${index}`);
        timerDiv.classList.remove('hidden');
        playSound('start');
        startTimer(300, display, () => {
          timerDiv.classList.add('hidden');
          currentActiveTask = null;
          enableTaskButtons();
        });
        console.log("Micro-task started, task:", taskId);
      }

      function completeMicroTask(index) {
        const taskId = `microTask${index}`;
        if (currentActiveTask !== taskId) return;
        if (timerInterval) {
          clearInterval(timerInterval);
          const timerDiv = document.getElementById(`microTaskTimer${index}`);
          const button = document.getElementById(`microTask-start-${index}`);
          triggerPartyPopper(timerDiv);
          updateXP(xpPerTask);
          markTaskCompleted(taskId, button);
          timerDiv.classList.add('hidden');
          currentActiveTask = null;
          enableTaskButtons();
        }
        console.log("Micro-task completed, task:", taskId);
      }

      function stopMicroTask(index) {
        const taskId = `microTask${index}`;
        if (currentActiveTask !== taskId) return;
        clearInterval(timerInterval);
        document.getElementById(`microTaskTimer${index}`).classList.add('hidden');
        playSound('end');
        currentActiveTask = null;
        enableTaskButtons();
        console.log("Micro-task stopped, index:", index);
      }

      function startWorkStretch(index) {
        const taskId = `workStretch${index}`;
        if (currentActiveTask !== null || completedTasks.includes(taskId)) return;
        currentActiveTask = taskId;
        disableTaskButtons(index);
        const timerDiv = document.getElementById(`workStretchTimer${index}`);
        const display = document.getElementById(`workStretchDisplay${index}`);
        const button = document.getElementById(`workStretch-start-${index}`);
        timerDiv.classList.remove('hidden');
        playSound('start');
        pomodoroPhase = 'work';
        runWorkStretch(index, display, timerDiv, button);
        console.log("Work-stretch started, task:", taskId);
      }

      function runWorkStretch(index, display, timerDiv, button) {
        const duration = pomodoroPhase === 'work' ? 900 : 300;
        startTimer(duration, display, () => {
          if (pomodoroPhase === 'work') {
            triggerPartyPopper(timerDiv);
            updateXP(xpPerTask);
            markTaskCompleted(`workStretch${index}`, button);
            pomodoroPhase = 'stretch';
            runWorkStretch(index, display, timerDiv, button);
          } else {
            pomodoroPhase = 'work';
            runWorkStretch(index, display, timerDiv, button);
          }
        }, () => {
          display.textContent = `${pomodoroPhase === 'work' ? 'Work' : 'Stretch'}: ${display.textContent}`;
        });
      }

      function stopWorkStretch(index) {
        const taskId = `workStretch${index}`;
        if (currentActiveTask !== taskId) return;
        clearInterval(timerInterval);
        document.getElementById(`workStretchTimer${index}`).classList.add('hidden');
        playSound('end');
        currentActiveTask = null;
        enableTaskButtons();
        console.log("Work-stretch stopped, index:", index);
      }

      function completeAccountability(index) {
        const taskId = `accountability${index}`;
        if (completedTasks.includes(taskId)) return;
        const input = document.getElementById(`accountability${index}`);
        const button = document.getElementById(`accountability-complete-${index}`);
        if (input.value.trim()) {
          triggerPartyPopper(button);
          updateXP(xpPerTask);
          markTaskCompleted(taskId, button);
        }
        console.log("Accountability completed, task:", taskId);
      }
    </script>
  </body>
</html>
